Create a Kubernetes Cluster using Proxmox Virtual Environment
References: https://www.youtube.com/watch?v=U1VzcjCB_sY
#######################################################


clone VM ubuntu22.08
850 k8s-controller - Full Clone - start at boot =yes, QEMU Guest Agent  = Enabled
851-k8s-node - Full Clone

start machines
login using cloud-init credetials.

sudo apt update && sudo apt upgarde -y
sudo apt install qemu-guest-agent
sudo reboot -h now (service qemu-guest-agent gets started post reboot, this is required to get IP address on Proxmox, we can check status by sudo systemctl status qemu-guest-agent)

note down IP address and connect from external ssh for better control (like mobaxterm with ssh keys already added in template through cloud-init). 

setup ssh keys logs fot all hosts.

setup static IP (as per above video) - i am skipping

install containerd
sudo apt install containerd (it will install runc and containerd)
sudo systemctl status containerd

sudo mkdir /etc/containerd
containerd config default | sudo tee /etc/containerd/config.toml

sudo vi /etc/containerd/config.toml
search section runc.options and change SystemdCgroup = true

disable swap, as k8s doesn work well
use free to check (sudo cat /etc/fstab) 

sudo vi /etc/sysctl.conf
uncomment line 
net.ipv4.ip_forward=1

# to support bridging in cluster
sudo vi /etc/modules-load.d/k8s.conf
cat /etc/modules-load.d/k8s.conf
br_netfilter

reboot



sudo apt-get install -y apt-transport-https ca-certificates curl

refer :https://kubernetes.io/blog/2023/08/15/pkgs-k8s-io-introduction/
curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.28/deb/Release.key | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
echo "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.28/deb/ /" | sudo tee /etc/apt/sources.list.d/kubernetes.list

sudo apt-get update
sudo apt-get install -y kubeadm kubectl kubelet

create a template of node instance
$ sudo rm -rf  /var/lib/cloud/instances
$ sudo truncate -s 0 /etc/machine-id
$ sudo rm /var/lib/dbus/machine-id
$ sudo ln -s /etc/machine-id /var/lib/dbus/machine-id
$ ls -l /var/lib/dbus/machine-id
lrwxrwxrwx 1 root root 15 Jun 10 05:38 /var/lib/dbus/machine-id -> /etc/machine-id
$ cat /etc/machine-id
$ sudo poweroff
proxmox -> make a template of 851 and clone 852, 853, 854 (full clone and k8s-node-1)

